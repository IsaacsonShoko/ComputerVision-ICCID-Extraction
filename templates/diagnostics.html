<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Diagnostics</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        button { padding: 10px 20px; margin: 5px; }
        #log { background: #f5f5f5; padding: 10px; height: 300px; overflow-y: scroll; }
    </style>
</head>
<body>
    <h1>üîß System Diagnostics</h1>
    
    <div class="test-section">
        <h3>1. Basic Connectivity Tests</h3>
        <button onclick="testStatus()">Test Status API</button>
        <button onclick="testStart()">Test Start API</button>
        <button onclick="testSocketIO()">Test SocketIO</button>
        <button onclick="testVideoFeed()">Test Video Feed</button>
    </div>
    
    <div class="test-section">
        <h3>2. Motor Speed & Belt Traction</h3>
        <p>Current motor settings: <span id="motorStatus">Loading...</span></p>
        <button onclick="getMotorSpeed()">Check Motor Speed</button>
        <button onclick="adjustMotorSpeed('slow')" style="background: #4CAF50; color: white;">üêå Slow (OCR Optimal)</button>
        <button onclick="adjustMotorSpeed('balanced')" style="background: #2196F3; color: white;">‚öñÔ∏è Balanced</button>
        <button onclick="adjustMotorSpeed('fast')" style="background: #FF9800; color: white;">üèÉ Fast</button>
        <button onclick="adjustMotorSpeed('max')" style="background: #f44336; color: white;">‚ö° Max Speed</button>
    </div>
    
    <div class="test-section">
        <h3>3. System Control</h3>
        <label>
            <input type="radio" name="provider" value="MTN" checked> MTN
        </label>
        <label>
            <input type="radio" name="provider" value="Vodacom"> Vodacom
        </label>
        <br><br>
        <button onclick="startSystemTest()" style="background: green; color: white;">üöÄ Start System</button>
        <button onclick="stopSystemTest()" style="background: red; color: white;">üõë Stop System</button>
    </div>
    
    <div class="test-section">
        <h3>3. Video Stream Test</h3>
        <img id="videoFrame" style="max-width: 400px; border: 1px solid #ccc;" alt="Video stream will appear here">
        <p>Frame count: <span id="frameCount">0</span></p>
        <p>Stream status: <span id="streamStatus">Not connected</span></p>
    </div>
    
    <div class="test-section">
        <h3>4. Debug Log</h3>
        <button onclick="clearLog()">Clear Log</button>
        <div id="log"></div>
    </div>

    <script>
        const API_BASE = '/api';
        let socket = null;
        let frameCount = 0;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : type === 'warning' ? 'orange' : 'black';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        async function testStatus() {
            log('Testing status API...');
            try {
                const response = await fetch(`${API_BASE}/status`);
                const data = await response.json();
                log(`‚úÖ Status API works: ${JSON.stringify(data)}`, 'success');
            } catch (error) {
                log(`‚ùå Status API failed: ${error}`, 'error');
            }
        }
        
        async function testStart() {
            log('Testing start API...');
            try {
                const response = await fetch(`${API_BASE}/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ service_provider: 'MTN' })
                });
                const data = await response.json();
                if (response.ok) {
                    log(`‚úÖ Start API works: ${data.message}`, 'success');
                } else {
                    log(`‚ö†Ô∏è Start API response: ${data.error}`, 'warning');
                }
            } catch (error) {
                log(`‚ùå Start API failed: ${error}`, 'error');
            }
        }
        
        function testSocketIO() {
            log('Testing SocketIO connection...');
            if (socket) {
                socket.disconnect();
            }
            
            socket = io({
                timeout: 10000,
                forceNew: true
            });
            
            socket.on('connect', function() {
                log('‚úÖ SocketIO connected successfully', 'success');
                document.getElementById('streamStatus').textContent = 'Connected';
            });
            
            socket.on('disconnect', function() {
                log('‚ùå SocketIO disconnected', 'warning');
                document.getElementById('streamStatus').textContent = 'Disconnected';
            });
            
            socket.on('connect_error', function(error) {
                log(`‚ùå SocketIO connection error: ${error}`, 'error');
            });
            
            socket.on('frame_update', function(data) {
                frameCount++;
                document.getElementById('frameCount').textContent = frameCount;
                
                if (data.frame) {
                    document.getElementById('videoFrame').src = `data:image/jpeg;base64,${data.frame}`;
                    log(`üìπ Frame ${frameCount} received (${data.resolution})`, 'success');
                } else {
                    log(`‚ö†Ô∏è Frame update without frame data`, 'warning');
                }
            });
            
            socket.on('connection_confirmed', function(data) {
                log(`‚úÖ Connection confirmed: ${JSON.stringify(data)}`, 'success');
            });
        }
        
        function testVideoFeed() {
            log('Testing HTTP video feed...');
            const img = new Image();
            img.onload = function() {
                log('‚úÖ HTTP video feed accessible', 'success');
            };
            img.onerror = function() {
                log('‚ùå HTTP video feed not accessible', 'error');
            };
            img.src = `${API_BASE}/camera/feed?t=${Date.now()}`;
        }
        
        async function startSystemTest() {
            const provider = document.querySelector('input[name="provider"]:checked').value;
            log(`üöÄ Starting system with ${provider}...`);
            
            try {
                const response = await fetch(`${API_BASE}/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ service_provider: provider })
                });
                
                const data = await response.json();
                if (response.ok) {
                    log(`‚úÖ System started: ${data.message}`, 'success');
                } else {
                    log(`‚ùå Start failed: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Start request failed: ${error}`, 'error');
            }
        }
        
        async function stopSystemTest() {
            log('üõë Stopping system...');
            try {
                const response = await fetch(`${API_BASE}/stop`, { method: 'POST' });
                const data = await response.json();
                log(`‚úÖ System stopped: ${data.message}`, 'success');
            } catch (error) {
                log(`‚ùå Stop failed: ${error}`, 'error');
            }
        }
        
        // Initialize
        window.addEventListener('load', function() {
            log('üîß Diagnostic page loaded');
            testSocketIO();
        });
    </script>
</body>
</html>